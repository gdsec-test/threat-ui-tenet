import '@ux/icon/x/index.css';
import { Button, Modal } from '@ux/uxcore2';
import { withRouter } from 'next/router';
import React, { useState } from 'react';
import { JSONTree } from 'react-json-tree';
import Loader from './common/Loader';
import RenderError from './common/RenderError';
import startVulnerabilityWatch from '../api/startVulnerabilityWatch';
import { expandData, formatData } from '../utils/dataFormatters';

export const VulnerabilityWatch = () => {
  const [showVulnModal, toggleVulnModal] = useState(false);
  const [report, setReport] = useState(null);
  return (
    <div
      style={{
        margin: 20
      }}
    >
      <Button
        design='primary'
        onClick={() => {
          toggleVulnModal(true);
          startVulnerabilityWatch()
            .then((watchReport) => {
              setReport(watchReport);
            })
            .catch((err) => {
              setReport(err);
            });
        }}
      >
        Start Vuln Scanner
      </Button>
      {showVulnModal && (
        <Modal
          title='Vulnerability Watch Report'
          onClose={() => {
            toggleVulnModal(false);
            setReport(null);
          }}
        >
          {report ? (
            <JSONTree
              data={report}
              theme={'monokai'}
              labelRenderer={(keyPath) => <b>{keyPath[0]}</b>}
              valueRenderer={formatData}
              shouldExpandNode={expandData}
            />
          ) : (
            <Loader inline size='lg' text='Loading report...' />
          )}
        </Modal>
      )}
    </div>
  );
};

export default withRouter(RenderError(VulnerabilityWatch));
